// This file is the single source of truth for our database schema.
// All fields from the Garage and MC reports have been added.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ----------------------------------------------------
// CORE MODELS (Unchanged from previous versions)
// ----------------------------------------------------
model person {
  person_id           String   @id @default(uuid())
  firstname           String
  lastname            String
  phone               String?  @unique
  email               String   @unique
  gender              String?
  civilStatus         String?
  birthday            DateTime?
  address             String?
  place_of_work       String?
  age_group           String?
  country             String?
  district            String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user                user?
  group_memberships   group_membership[]
  event_attendances   event_attendance[]
  report_attendances  report_attendance[]
}

model church {
  church_id String @id @default(uuid())
  name      String @unique
  users     user[]
}

model roles {
  role_id     String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions String[]
  isActive    Boolean  @default(true)
  users       user[]
}

model user {
  user_id         String @id @default(uuid())
  username        String @unique
  password_hash   String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  person    person @relation(fields: [person_id], references: [person_id])
  person_id String @unique
  
  role      roles  @relation(fields: [role_id], references: [role_id])
  role_id   String
  
  church    church @relation(fields: [church_id], references: [church_id])
  church_id String
  
  submitted_reports report_submission[]
}

model group {
  group_id    String   @id @default(uuid())
  name        String
  description String?
  members     group_membership[]
}

model group_membership {
  @@id([person_id, group_id])
  person    person @relation(fields: [person_id], references: [person_id])
  person_id String
  group     group  @relation(fields: [group_id], references: [group_id])
  group_id  String
  assignedAt  DateTime @default(now())
}

model events {
  event_id    String   @id @default(uuid())
  name        String
  description String?
  start_time  DateTime
  end_time    DateTime
  location    String?
  attendees   event_attendance[]
}

model event_attendance {
  @@id([person_id, event_id])
  person    person @relation(fields: [person_id], references: [person_id])
  person_id String
  event     events @relation(fields: [event_id], references: [event_id])
  event_id  String
  registeredAt DateTime @default(now())
}

model report_type {
  report_type_id String @id @default(uuid())
  name           String @unique // e.g., "MC Report", "Garage Report"
  description    String?
  submissions    report_submission[]
}

// ----------------------------------------------------
// --- UPDATED CORE REPORT MODELS ---
// ----------------------------------------------------

// Model for linking attendees to any report submission
model report_attendance {
  @@id([person_id, report_submission_id])
  person               person            @relation(fields: [person_id], references: [person_id])
  person_id            String
  report_submission    report_submission @relation(fields: [report_submission_id], references: [report_submission_id])
  report_submission_id String
}

// Model for a report submission record (The Header)
model report_submission {
  report_submission_id String   @id @default(uuid())
  submission_date      DateTime @default(now())
  status               String   @default("Submitted")
  
  // Relations to User and Type
  submitter         user   @relation(fields: [submitter_user_id], references: [user_id])
  submitter_user_id String
  type              report_type @relation(fields: [report_type_id], references: [report_type_id])
  report_type_id    String
  
  // Attendees link (many-to-many)
  attendees         report_attendance[]

  // One-to-one link to specific data tables (One will be null, the other populated)
  garage_data       garage_report_data?
  mc_data           mc_report_data?
}

// ----------------------------------------------------
// --- NEW MODEL 1: GARAGE REPORT DATA ---
// ----------------------------------------------------
model garage_report_data {
  report_submission_id            String    @unique // PK and FK to report_submission
  report_submission               report_submission @relation(fields: [report_submission_id], references: [report_submission_id])

  dateTimeOfGathering             DateTime
  smallGroupName                  String
  smallGroupId                    String?
  attendanceTotal                 Int
  attendanceTeens                 Int?
  attendanceKids                  Int?
  attendanceFTGs                  Int?
  involvementVolunters            Int?
  
  // Use Decimal for financial data (Best practice for money)
  contributionTithesOfferings     Decimal?  @db.Decimal(10, 2)
  contributionProjects            Decimal?  @db.Decimal(10, 2)
  contributionOther               Decimal?  @db.Decimal(10, 2)

  involvementSmallgroupAttendance Int?
  salvations                      Int?
  inHouseSalvations               Int?
  salvationsBaptism               Int?
  salvationsRecommitments         Int?
  visitations                     Int?
  dmcAttendance                   Int?
  fireplaceAttendance             Int?
  careCallsMade                   Int?
  frontiersEngaged                Int
  numberOfMCs                     Int
  notes                           String?   @db.Text
}

// ----------------------------------------------------
// --- NEW MODEL 2: MC REPORT DATA ---
// ----------------------------------------------------
model mc_report_data {
  report_submission_id            String    @unique // PK and FK to report_submission
  report_submission               report_submission @relation(fields: [report_submission_id], references: [report_submission_id])

  date                            DateTime
  smallGroupName                  String
  smallGroupId                    String?
  mcHostHome                      String
  smallGroupNumberOfMembers       Int
  mcHuddleCount                   Int
  smallGroupAttendanceCount       Int
  
  // Text fields for feedback/stories
  mcAttendeeNames                 String    @db.Text // Use @db.Text for large textarea fields
  mcGeneralFeedback               String    @db.Text
  mcWordHighlights                String    @db.Text
  mcTestimonies                   String    @db.Text
  mcPrayerRequest                 String    @db.Text
  mcFrontierStory                 String?   @db.Text
}